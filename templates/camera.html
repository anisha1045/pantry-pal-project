<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take a Photo - Pantry Pal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container d-flex align-items-center">
            <a class="navbar-brand" href="#!">ðŸ¥— Pantry Pal</a>
            <a class="navbar-item" href="{{ url_for('log') }}">Log</a>
            <a class="navbar-item" href="{{ url_for('planner') }}">Planner</a>
            <a class="navbar-item" href="{{ url_for('library') }}">Library</a>
            {% if session.username %}
            <a class="navbar-item d-flex align-items-center" href="{{ url_for('logout') }}">
                <img src="profile.jpg" alt="Profile" style="width: 40px; height: 40px; background-color: white; border-radius: 50%; margin-right: 15px;">
                Sign Out
            </a>
            {% else %}
            <a class="navbar-item d-flex align-items-center" href="{{ url_for('sign_in') }}">
                <img src="profile.jpg" alt="Profile" style="width: 40px; height: 40px; background-color: white; border-radius: 50%; margin-right: 15px;">
                Sign In
            </a>
            {% endif %}
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="bi bi-camera"></i> Take a Picture of Your Food</h3>
                    </div>
                    <div class="card-body text-center">
                        <video id="video" width="320" height="240" autoplay class="border rounded mb-3"></video>
                        <br>
                        <button id="snap" class="btn btn-primary btn-lg">
                            <i class="bi bi-camera"></i> Capture Photo
                        </button>
                        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
                        
                        <div id="loading" style="display:none;" class="mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Processing your meal photo...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snap = document.getElementById('snap');
        const loading = document.getElementById('loading');

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => video.srcObject = stream)
            .catch(err => {
                console.error("Camera error:", err);
                alert("Camera access denied or not available. Please allow camera access and try again.");
            });

        snap.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, 320, 240);
            const image = canvas.toDataURL('image/png');

            loading.style.display = 'block';
            snap.disabled = true;

            // Send image to backend
            fetch('/upload-photo', {
                method: 'POST',
                body: JSON.stringify({ image }),
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(res => res.json())
            .then(data => {
                loading.style.display = 'none';
                snap.disabled = false;
                
                if (data.success) {
                    alert("Image uploaded and meal logged successfully!");
                    window.location.href = '/dashboard';
                } else {
                    alert("Error: " + data.error);
                }
            }).catch(err => {
                loading.style.display = 'none';
                snap.disabled = false;
                alert("Error uploading image: " + err.message);
            });
        });
    </script>
</body>
</html>